rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // NESTED SCHOOL STRUCTURE SECURITY RULES
    // ============================================

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData(schoolId) {
      let userPath = /databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid);
      let parentPath = /databases/$(database)/documents/schools/$(schoolId)/parents/$(request.auth.uid);

      return exists(userPath) ? get(userPath).data :
             exists(parentPath) ? get(parentPath).data : null;
    }

    function isSchoolAdmin(schoolId) {
      return isSignedIn() && getUserData(schoolId).role == 'schoolAdmin';
    }

    function isTeacher(schoolId) {
      return isSignedIn() && getUserData(schoolId).role == 'teacher';
    }

    function belongsToSchool(schoolId) {
      return isSignedIn() &&
             (exists(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid)) ||
              exists(/databases/$(database)/documents/schools/$(schoolId)/parents/$(request.auth.uid)));
    }

    // ============================================
    // Schools Collection
    // ============================================
    match /schools/{schoolId} {
      // Allow authenticated users to list schools (for login)
      allow list: if isSignedIn();

      // School document - read for members, write for admins
      allow get: if belongsToSchool(schoolId);
      allow write: if isSchoolAdmin(schoolId);

      // ============================================
      // Users Subcollection (staff, teachers, admins)
      // ============================================
      match /users/{userId} {
        // Allow user to read their own profile (including during login)
        allow read: if isSignedIn() && request.auth.uid == userId;

        // Admins and teachers can read all users in their school
        allow read: if isSchoolAdmin(schoolId) || isTeacher(schoolId);

        // Users can update their own profile
        allow update: if isSignedIn() && request.auth.uid == userId;

        // Admins can create, update, and delete any user in their school
        allow create: if isSignedIn() &&
                         request.resource.data.schoolId == schoolId;

        allow update: if isSignedIn() &&
                         (request.auth.uid == userId || isSchoolAdmin(schoolId));

        // Admins have full delete permissions for users in their school
        // Using a more permissive check that allows admins to delete users
        allow delete: if isSignedIn() &&
                         (isSchoolAdmin(schoolId) ||
                          exists(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid)) &&
                          get(/databases/$(database)/documents/schools/$(schoolId)/users/$(request.auth.uid)).data.role == 'schoolAdmin');
      }

      // ============================================
      // Parents Subcollection
      // ============================================
      match /parents/{parentId} {
        // Allow parent to read their own profile (including during login)
        allow read: if isSignedIn() && request.auth.uid == parentId;

        // Admins and teachers can read all parents
        allow read: if isSchoolAdmin(schoolId) || isTeacher(schoolId);

        // Parents can update their own profile
        allow update: if isSignedIn() && request.auth.uid == parentId;

        // Admins can update any parent in their school
        allow update: if isSchoolAdmin(schoolId);

        // Allow authenticated users to create parent documents
        allow create: if isSignedIn() &&
                         request.resource.data.schoolId == schoolId;

        // Only admins can delete parents
        allow delete: if isSchoolAdmin(schoolId);
      }

      // ============================================
      // Students Subcollection
      // ============================================
      match /students/{studentId} {
        // Admins and teachers can read all students
        allow read: if isSchoolAdmin(schoolId) || isTeacher(schoolId);

        // Parents can read their linked children
        allow read: if isSignedIn() &&
                       studentId in getUserData(schoolId).linkedChildren;

        // Admins and teachers can create/update/delete students
        allow create: if isSignedIn() &&
                         request.resource.data.schoolId == schoolId;

        allow update, delete: if isSchoolAdmin(schoolId) || isTeacher(schoolId);
      }

      // ============================================
      // Classes Subcollection
      // ============================================
      match /classes/{classId} {
        // Admins can read all classes
        allow read: if isSchoolAdmin(schoolId);

        // Teachers can read classes they're assigned to
        allow read: if isTeacher(schoolId) &&
                       (resource.data.teacherId == request.auth.uid ||
                        (resource.data.teacherIds != null &&
                         request.auth.uid in resource.data.teacherIds));

        // Parents can read classes their children are in
        allow read: if isSignedIn() &&
                       getUserData(schoolId).linkedChildren != null &&
                       resource.data.studentIds.hasAny(getUserData(schoolId).linkedChildren);

        // Only admins can create/delete classes
        allow create, delete: if isSchoolAdmin(schoolId);

        // Admins can update any class, teachers can only update their assigned classes
        allow update: if isSchoolAdmin(schoolId) ||
                         (isTeacher(schoolId) &&
                          (resource.data.teacherId == request.auth.uid ||
                           (resource.data.teacherIds != null &&
                            request.auth.uid in resource.data.teacherIds)));
      }

      // ============================================
      // Reading Logs Subcollection
      // ============================================
      match /readingLogs/{logId} {
        // Admins and teachers can read all logs
        allow read: if isSchoolAdmin(schoolId) || isTeacher(schoolId);

        // Parents can read logs for their children
        allow read: if isSignedIn() &&
                       resource.data.studentId in getUserData(schoolId).linkedChildren;

        // Parents can create logs for their children
        allow create: if isSignedIn() &&
                         request.resource.data.studentId in getUserData(schoolId).linkedChildren &&
                         request.resource.data.parentId == request.auth.uid;

        // Parents can update their own logs
        allow update: if isSignedIn() && resource.data.parentId == request.auth.uid;

        // Teachers and admins can update any log
        allow update: if isSchoolAdmin(schoolId) || isTeacher(schoolId);

        // Only admins can delete logs
        allow delete: if isSchoolAdmin(schoolId);
      }

      // ============================================
      // Allocations Subcollection
      // ============================================
      match /allocations/{allocationId} {
        // Everyone in the school can read allocations
        allow read: if belongsToSchool(schoolId);

        // Only teachers and admins can write allocations
        allow write: if isSchoolAdmin(schoolId) || isTeacher(schoolId);
      }
    }

    // ============================================
    // School Onboarding Collection (top-level)
    // ============================================
    match /schoolOnboarding/{onboardingId} {
      // Anyone can create a demo request (unauthenticated)
      allow create: if true;

      // Owner can read their onboarding
      allow read: if isSignedIn() &&
                     (resource.data.contactEmail == request.auth.token.email ||
                      resource.data.adminUserId == request.auth.uid);

      // Owner can update their onboarding
      allow update: if isSignedIn() &&
                       (resource.data.contactEmail == request.auth.token.email ||
                        resource.data.adminUserId == request.auth.uid);
    }

    // ============================================
    // Student Link Codes Collection (top-level)
    // ============================================
    match /studentLinkCodes/{codeId} {
      // Allow list queries for code verification (parent registration flow)
      // Restrict to single document queries with limit to prevent enumeration
      // Note: This still allows unauthenticated verification but limits abuse
      // Consider implementing rate limiting at app/Cloud Functions level for production
      allow list: if request.query.limit == 1 &&
                     resource.data.status == 'active' &&
                     resource.data.expiresAt.toMillis() > request.time.toMillis();

      // Allow direct document get for authenticated users only
      allow get: if isSignedIn();

      // School admins and teachers can read all codes for their school
      allow list: if isSignedIn() &&
                     (isSchoolAdmin(resource.data.schoolId) ||
                      isTeacher(resource.data.schoolId));

      // Parents can read codes they've used
      allow get: if isSignedIn() &&
                    resource.data.usedBy == request.auth.uid;

      // School admins and teachers can create codes
      allow create: if isSignedIn() &&
                       (isSchoolAdmin(request.resource.data.schoolId) ||
                        isTeacher(request.resource.data.schoolId));

      // School admins and teachers can update codes
      // Parents can update codes when linking (within transaction)
      allow update: if isSignedIn() &&
                       (isSchoolAdmin(resource.data.schoolId) ||
                        isTeacher(resource.data.schoolId) ||
                        (request.auth.uid == request.resource.data.usedBy &&
                         resource.data.status == 'active' &&
                         request.resource.data.status == 'used'));

      // Only school admins can delete codes
      allow delete: if isSignedIn() && isSchoolAdmin(resource.data.schoolId);
    }

    // ============================================
    // Notifications Collection (top-level)
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isSignedIn() &&
                     (resource.data.userId == request.auth.uid ||
                      resource.data.parentUserId == request.auth.uid);

      // System can create notifications
      allow create: if isSignedIn();

      // Users can update their own notifications (e.g., mark as read)
      allow update: if isSignedIn() &&
                       (resource.data.userId == request.auth.uid ||
                        resource.data.parentUserId == request.auth.uid);

      // Only admins can delete notifications
      allow delete: if isSignedIn() &&
                       exists(/databases/$(database)/documents/schools/$(resource.data.schoolId)/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/schools/$(resource.data.schoolId)/users/$(request.auth.uid)).data.role == 'schoolAdmin';
    }
  }
}
